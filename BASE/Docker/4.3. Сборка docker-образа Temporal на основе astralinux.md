0.Готовая сборка находится здесь [https://git.компания.ru/rpn/dms/devops/docker-images/temporal](https://git.компания.ru/rpn/dms/devops/docker-images/temporal)

1.Для примера взят инструмент temporal - это фреймворк разработки программного обеспечения, который позволяет разработчикам создавать приложения, в которых различные задачи могут быть организованы как потоки выполнения, имеющие долговременное состояние и возобновимые после возможных сбоев или сбоев в системе.

2.Необходимо собрать docker-образ на основе докерфайла с образом-основой Astralinux и осуществить сборку необходимого инструмента из исходников с учётом условий для успешного прохождения сертификации в лаборатории по безопасности, которая будет анализировать процесс сборки.

3.В данном случае, с учётом поддерживаемых на данный момент ядром Astralinux alse:1.7.3 пакетов, возникла необходимость использовать версию сборщика Golang - `go1.15.9` и версию фреймворка  temporal - `temporalio v1.7.2`.
Дело в том,что при установке Golang на чистом образе Astralinux командой  `apt-get install golang-go` , из репозиториев Astralinux ставится версия сборщика Golang - go1.15.9 и мы должны подобрать к ней новейшую из поддерживаемых версию temporal. Например, при помощи информации на Гитхабе (иногда в исходниках программы,которую надо собрать, информация о версии голанг имеется в файле go.mod).

4.В этом примере создаётся архив temporal_sources_with_vendor_catalog.tar.gz, в котором упаковываются исходники инструмента temporal, а также все необходимые зависимости, которые потребуются в дальнейшем при сборке bin внутри контейнера командой `RUN make temporal-server.` При этом все необходимые зависимости добавляются в архив для того,чтобы повысить безопасность и пройти сертификацию. Для того, чтобы при сборке bin , сборщик Golang не обращался ни к каким репозиториям в интернете, а брал файлы из распакованного архива. 

5.Все эти действия позволяют образу собираться без обращения к сторонним репозиториям в сети. И докачивать пакеты исключительно из доверительных репозиториев Astralinux(например во время установки инструментария в контейнере `apt-get install make git golang-go -y`).

Далее приведён код Dockerfile с комментариями.
```
FROM registry.astralinux.ru/library/alse:1.7.3 AS builder
#Используется базовый образ "registry.astralinux.ru/library/alse:1.7.3" в качестве базового образа с именем "builder".

COPY temporal_sources_with_vendor_catalog.tar.gz /temporal_sources_with_vendor_catalog.tar.gz
#Копируется файл "temporal_sources_with_vendor_catalog.tar.gz" из локальной директории 
#в контейнер с именем "/temporal_sources_with_vendor_catalog.tar.gz".

RUN tar -xzvf /temporal_sources_with_vendor_catalog.tar.gz -C /
#Распаковывается архив "temporal_sources_with_vendor_catalog.tar.gz" в корневую директорию контейнера.

RUN set -eux && 
apt-get update && 
apt-get install make git golang-go -y
#Устанавливаются необходимые пакеты и зависимости: "make", "git" и "golang-go".

WORKDIR /temporal-1.7.2
#Устанавливается текущая рабочая директория внутри контейнера на "/temporal-1.7.2".

RUN make temporal-server
#Запускается команда "make temporal-server" для сборки сервера "temporal-server".

RUN /temporal-1.7.2/temporal-server -v
#Запускается сервер "temporal-server" с параметром "-v" для вывода его версии.

FROM registry.astralinux.ru/library/alse:1.7.3
#Используется тот же базовый образ "registry.astralinux.ru/library/alse:1.7.3" для второго этапа сборки.

COPY --from=builder /temporal-1.7.2/temporal-server  /usr/local/bin/temporal-server
#Копируется исполняемый файл "temporal-server" из предыдущего этапа сборки с именем "builder" 
#в директорию "/usr/local/bin" в текущем образе.

EXPOSE 7233
#Объявляется, что контейнер будет слушать порт 7233.

CMD ["/usr/local/bin/temporal-server"]
#Устанавливается команда по умолчанию, которая будет выполняться при запуске контейнера.
#В данном случае, это запуск сервера "temporal-server".
```

7.Состав архива с исходниками определяется экспериментальным путём- к примеру, в случае с temporal, конкретно в рассматриваемом примере, сборщику golang было достаточно данных из папки vendor в корне проекта. Для этого потребуется в папке с проектом ввести команду  `go mod vendor` , она поместит зависимости и вложенные модули в папку vendor.

8.В случае со сборкой образов других инструментов, может потребоваться подбирать состав архивов для сборки bin экспериментально, для того, чтобы сократить объёмы архивов.

К примеру, при сборке Consul используется папка  ~/go/pkg/mod,   папка vendor сборке не нужна. Папка  ~/go/pkg/mod заполняется зависимостями и модулями, необходимыми для сборки bin, командой `go get -u ./...` . А папка  vendor сборке не нужна.
Готовая сборка находится здесь [https://git.компания.ru/rpn/dms/devops/docker-images/consul](https://git.компания.ru/rpn/dms/devops/docker-images/consul)

9.Старайтесь оптимизировать размер архивов, т.к. они возможно будут храниться в небесконечных репозиториях компания, при сборке затратятся лишние мощности на распаковку архивов с излишними данными.